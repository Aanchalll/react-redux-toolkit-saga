'use strict';
const { test } = require('uvu');
const assert = require('uvu/assert');
const postcss = require('postcss');

const reduceCalc = require('../index.js');

const postcssOpts = { from: undefined };

function testValue(fixture, expected, opts = {}) {
  fixture = `foo{bar:${fixture}}`;
  expected = `foo{bar:${expected}}`;

  return async () => {
    const result = await postcss(reduceCalc(opts)).process(
      fixture,
      postcssOpts
    );
    assert.is(result.css, expected);
  };
}

function testCss(fixture, expected, opts = {}) {
  return async () => {
    const result = await postcss(reduceCalc(opts)).process(
      fixture,
      postcssOpts
    );
    assert.is(result.css, expected);
  };
}

function testThrows(fixture, expected, warning, opts = {}) {
  fixture = `foo{bar:${fixture}}`;
  expected = `foo{bar:${expected}}`;

  return async () => {
    const result = await postcss(reduceCalc(opts)).process(
      fixture,
      postcssOpts
    );
    const warnings = result.warnings();
    assert.is(result.css, expected);
    assert.is(warnings[0].text, warning);
  };
}

test('should reduce simple calc (1)', testValue('calc(1px + 1px)', '2px'));

test(
  'should reduce simple calc (2)',
  testValue('calc(1px + 1px);baz:calc(2px+3px)', '2px;baz:5px')
);

test('should reduce simple calc (3)', testValue('calc(1rem * 1.5)', '1.5rem'));

test('should reduce simple calc (4)', testValue('calc(3em - 1em)', '2em'));

test('should reduce simple calc (5', testValue('calc(2ex / 2)', '1ex'));

test(
  'should reduce simple calc (6)',
  testValue('calc(50px - (20px - 30px))', '60px')
);

test(
  'should reduce simple calc (7)',
  testValue('calc(100px - (100px - 100%))', '100%')
);

test(
  'should reduce simple calc (8)',
  testValue('calc(100px + (100px - 100%))', 'calc(200px - 100%)')
);

test(
  'should reduce additions and subtractions (1)',
  testValue('calc(100% - 10px + 20px)', 'calc(100% + 10px)')
);

test(
  'should reduce additions and subtractions (2)',
  testValue('calc(100% + 10px - 20px)', 'calc(100% - 10px)')
);

test(
  'should reduce additions and subtractions (3)',
  testValue('calc(1px - (2em + 3%))', 'calc(1px - 2em - 3%)')
);

test(
  'should reduce additions and subtractions (4)',
  testValue('calc((100vw - 50em) / 2)', 'calc(50vw - 25em)')
);

test(
  'should reduce additions and subtractions (5)',
  testValue('calc(10px - (100vw - 50em) / 2)', 'calc(10px - 50vw + 25em)')
);

test(
  'should reduce additions and subtractions (6)',
  testValue('calc(1px - (2em + 4vh + 3%))', 'calc(1px - 2em - 4vh - 3%)')
);

test(
  'should reduce additions and subtractions (7)',
  testValue(
    'calc(0px - (24px - (var(--a) - var(--b)) / 2 + var(--c)))',
    'calc(-24px + (var(--a) - var(--b))/2 - var(--c))'
  )
);

test(
  'should reduce additions and subtractions (8)',
  testValue('calc(1px + (2em + (3vh + 4px)))', 'calc(5px + 2em + 3vh)')
);

test(
  'should reduce additions and subtractions (9)',
  testValue('calc(1px - (2em + 4px - 6vh) / 2)', 'calc(-1px - 1em + 3vh)')
);

test(
  'should reduce multiplication',
  testValue('calc(((var(--a) + 4px) * 2) * 2)', 'calc((var(--a) + 4px)*2*2)')
);

test(
  'should reduce multiplication before reducing additions',
  testValue(
    'calc(((var(--a) + 4px) * 2) * 2 + 4px)',
    'calc((var(--a) + 4px)*2*2 + 4px)'
  )
);

test(
  'should reduce division',
  testValue('calc(((var(--a) + 4px) / 2) / 2)', 'calc((var(--a) + 4px)/2/2)')
);

test(
  'should reduce division before reducing additions',
  testValue(
    'calc(((var(--a) + 4px) / 2) / 2 + 4px)',
    'calc((var(--a) + 4px)/2/2 + 4px)'
  )
);

test(
  'should ignore value surrounding calc function (1)',
  testValue('a calc(1px + 1px)', 'a 2px')
);

test(
  'should ignore value surrounding calc function (2)',
  testValue('calc(1px + 1px) a', '2px a')
);

test(
  'should ignore value surrounding calc function (3)',
  testValue('a calc(1px + 1px) b', 'a 2px b')
);

test(
  'should ignore value surrounding calc function (4)',
  testValue('a calc(1px + 1px) b calc(1em + 2em) c', 'a 2px b 3em c')
);

test(
  'should reduce nested calc',
  testValue('calc(100% - calc(50% + 25px))', 'calc(50% - 25px)')
);

test(
  'should reduce vendor-prefixed nested calc',
  testValue(
    '-webkit-calc(100% - -webkit-calc(50% + 25px))',
    '-webkit-calc(50% - 25px)'
  )
);

test('should reduce uppercase calc (1)', testValue('CALC(1px + 1px)', '2px'));

test(
  'should reduce uppercase calc (2)',
  testValue('CALC(1px + CALC(2px / 2))', '2px')
);

test(
  'should reduce uppercase calc (3)',
  testValue('-WEBKIT-CALC(1px + 1px)', '2px')
);

test(
  'should reduce uppercase calc (4)',
  testValue('-WEBKIT-CALC(1px + -WEBKIT-CALC(2px / 2))', '2px')
);

test(
  'should ignore calc with css variables (1)',
  testValue('calc(var(--mouseX) * 1px)', 'calc(var(--mouseX)*1px)')
);

test(
  'should ignore calc with css variables (2)',
  testValue(
    'calc(10px - (100px * var(--mouseX)))',
    'calc(10px - 100px*var(--mouseX))'
  )
);

test(
  'should ignore calc with css variables (3)',
  testValue(
    'calc(10px - (100px + var(--mouseX)))',
    'calc(-90px - var(--mouseX))'
  )
);

test(
  'should ignore calc with css variables (4)',
  testValue(
    'calc(10px - (100px / var(--mouseX)))',
    'calc(10px - 100px/var(--mouseX))'
  )
);

test(
  'should ignore calc with css variables (5)',
  testValue(
    'calc(10px - (100px - var(--mouseX)))',
    'calc(-90px + var(--mouseX))'
  )
);

test(
  'should ignore calc with css variables (6)',
  testValue('calc(var(--popupHeight) / 2)', 'calc(var(--popupHeight)/2)')
);

test(
  'should ignore calc with css variables (7)',
  testValue(
    'calc(var(--popupHeight) / 2 + var(--popupWidth) / 2)',
    'calc(var(--popupHeight)/2 + var(--popupWidth)/2)'
  )
);

test(
  'should reduce calc with newline characters',
  testValue('calc(\n1rem \n* 2 \n* 1.5)', '3rem')
);

test(
  'should preserve calc with incompatible units',
  testValue('calc(100% + 1px)', 'calc(100% + 1px)')
);

test(
  'should parse fractions without leading zero',
  testValue('calc(2rem - .14285em)', 'calc(2rem - 0.14285em)')
);

test('should handle precision correctly (1)', testValue('calc(1/100)', '0.01'));

test(
  'should handle precision correctly (2)',
  testValue('calc(5/1000000)', '0.00001')
);

test(
  'should handle precision correctly (3)',
  testValue('calc(5/1000000)', '0.000005', { precision: 6 })
);

test(
  'should reduce browser-prefixed calc (1)',
  testValue('-webkit-calc(1px + 1px)', '2px')
);

test(
  'should reduce browser-prefixed calc (2)',
  testValue('-moz-calc(1px + 1px)', '2px')
);

test(
  'should discard zero values (#2) (1)',
  testValue('calc(100vw / 2 - 6px + 0px)', 'calc(50vw - 6px)')
);

test(
  'should discard zero values (#2) (2)',
  testValue('calc(500px - 0px)', '500px')
);

test(
  'should not perform addition on unitless values (#3)',
  testValue('calc(1px + 1)', 'calc(1px + 1)')
);

test(
  'should reduce consecutive substractions (#24) (1)',
  testValue('calc(100% - 120px - 60px)', 'calc(100% - 180px)')
);

test(
  'should reduce consecutive substractions (#24) (2)',
  testValue('calc(100% - 10px - 20px)', 'calc(100% - 30px)')
);

test(
  'should reduce mixed units of time (postcss-calc#33)',
  testValue('calc(1s - 50ms)', '0.9